name: CI-CD Build & Deploy

on:
  push:
    branches: ["dev"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DEPLOY_CONFIG: ${{ secrets.DEPLOY_CONFIG }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check DEPLOY_CONFIG
        run: |-
          echo "checking DEPLOY_CONFIG"
          echo "$DEPLOY_CONFIG" | jq

      - name: Parse deploy config
        run: |
          echo "$DEPLOY_CONFIG" > config.json
          export DOCKERHUB_USERNAME=$(jq -r '.DOCKERHUB_USERNAME' config.json)
          export DOCKERHUB_PASSWORD=$(jq -r '.DOCKERHUB_PASSWORD' config.json)
          export KUBECONFIG_DATA=$(jq -r '.KUBECONFIG_DATA' config.json)

          echo "DOCKERHUB_USERNAME=$DOCKERHUB_USERNAME" >> $GITHUB_ENV
          echo "DOCKERHUB_PASSWORD=$DOCKERHUB_PASSWORD" >> $GITHUB_ENV
          echo "KUBECONFIG_DATA=$KUBECONFIG_DATA" >> $GITHUB_ENV

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push with cache
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: dsct/daesan-pms:${{ github.sha }}
          platforms: linux/amd64
          cache-from: type=registry,ref=dsct/daesan-pms:buildcache
          cache-to: type=registry,ref=dsct/daesan-pms:buildcache,mode=max

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 --decode > ~/.kube/config
          cat ~/.kube/config

      - name: Deploy to cluster
        uses: actions-hub/kubectl@master
        env:
          KUBE_CONFIG: ${{ env.KUBECONFIG_DATA }}
        with:
          args: set image deployment/web web=dsct/daesan-pms:${{ github.sha }} -n pms-web

      - name: Wait for rollout
        uses: actions-hub/kubectl@master
        env:
          KUBE_CONFIG: ${{ env.KUBECONFIG_DATA }}
        with:
          args: wait pod -l app=pms-web -n pms-web --for=condition=ready --timeout=30s

      - name: Rollback on failure
        if: failure()
        uses: actions-hub/kubectl@master
        env:
          KUBE_CONFIG: ${{ env.KUBECONFIG_DATA }}
        with:
          args: rollout undo deployment/web -n pms-web
